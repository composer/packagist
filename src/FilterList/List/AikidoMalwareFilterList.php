<?php declare(strict_types=1);

/*
 * This file is part of Packagist.
 *
 * (c) Jordi Boggiano <j.boggiano@seld.be>
 *     Nils Adermann <naderman@naderman.de>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

namespace App\FilterList\List;

use App\FilterList\FilterListCategories;
use App\FilterList\FilterLists;
use App\FilterList\RemoteFilterListEntry;
use Psr\Log\LoggerInterface;
use Symfony\Contracts\HttpClient\HttpClientInterface;

class AikidoMalwareFilterList implements FilterListInterface
{
    private const string FEED_URL = 'https://malware-list.aikido.dev/malware_packagist.json';

    public function __construct(
        private HttpClientInterface $httpClient,
        private LoggerInterface $logger,
    ) {}

    public function getListEntries(): ?array
    {
        try {
            $data = json_decode(
                $this->httpClient->request('GET', self::FEED_URL)->getContent(),
                true,
                flags: JSON_THROW_ON_ERROR,
            );
        } catch (\Throwable $e) {
            $this->logger->error('Failed to fetch Aikido malware list', [
                'exception' => $e,
            ]);

            return null;
        }

        $entries = [];
        foreach ($data as $entry) {
            $packageName = strtolower($entry['package_name']);
            $reason = strtolower($entry['reason']);

            if ($reason !== 'malware') {
                continue;
            }

            $entries[] = new RemoteFilterListEntry(
                $packageName,
                $entry['version'],
                FilterLists::AIKIDO_MALWARE,
                FilterListCategories::MALWARE,
                sprintf('https://app.aikido.dev/reports/malware/software-supply-chain-attacks?search=%s&ecosystem=packagist', urlencode($packageName)),
            );
        }

        return $entries;
    }
}
